<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocVia - Smart Document Segmentation</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #667eea;
        --primary-dark: #764ba2;
        --accent: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --text-dark: #1f2937;
        --text-gray: #6b7280;
        --border: #e5e7eb;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .auth-container {
        width: 100%;
        max-width: 420px;
      }

      .auth-box {
        background: var(--bg-white);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        padding: 48px 40px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        text-align: center;
        margin-bottom: 40px;
      }

      .logo h1 {
        color: var(--primary);
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .logo p {
        color: var(--text-gray);
        font-size: 14px;
        font-weight: 500;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 10px;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 14px;
      }

      input, textarea {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s;
        font-family: inherit;
        background: var(--bg-light);
      }

      input:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-white);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      }

      input.error {
        border-color: var(--danger);
      }

      .error-message {
        color: var(--danger);
        font-size: 13px;
        margin-top: 8px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-family: inherit;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .google-btn {
        background: var(--bg-white);
        color: var(--text-dark);
        border: 2px solid var(--border);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        font-weight: 600;
      }

      .google-btn:hover:not(:disabled) {
        background: var(--bg-light);
        border-color: var(--primary);
      }

      .divider {
        text-align: center;
        margin: 28px 0;
        position: relative;
      }

      .divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--border);
      }

      .divider span {
        background: var(--bg-white);
        padding: 0 12px;
        position: relative;
        color: var(--text-gray);
        font-size: 13px;
        font-weight: 500;
      }

      .message {
        padding: 14px 16px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        animation: slideDown 0.3s ease-out;
        border-left: 4px solid;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
        border-left-color: var(--accent);
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
        border-left-color: var(--danger);
      }

      .message.info {
        background: #dbeafe;
        color: #1e40af;
        border-left-color: var(--primary);
      }

      .link-btn {
        background: none;
        color: var(--primary);
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
        margin-top: 12px;
        padding: 8px 0;
        font-weight: 600;
        border: none;
        transition: color 0.2s;
      }

      .link-btn:hover {
        color: var(--primary-dark);
        text-decoration: underline;
      }

      .text-center {
        text-align: center;
      }

      .profile-container {
        width: 100%;
        max-width: 1200px;
      }

      .profile-header {
        background: var(--bg-white);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-card {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .user-avatar {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        border: 4px solid var(--primary);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .user-info h2 {
        color: var(--text-dark);
        font-size: 24px;
        margin-bottom: 4px;
      }

      .user-info p {
        color: var(--text-gray);
        font-size: 14px;
      }

      .logout-btn {
        background: var(--danger);
        padding: 12px 24px;
        width: auto;
      }

      .logout-btn:hover {
        background: #dc2626;
      }

      .section {
        background: var(--bg-white);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .section h3 {
        color: var(--text-dark);
        font-size: 20px;
        margin-bottom: 30px;
        font-weight: 700;
      }

      .upload-area {
        border: 2px dashed var(--primary);
        border-radius: 12px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      }

      .upload-area:hover {
        border-color: var(--primary-dark);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      }

      .upload-area p {
        color: var(--text-dark);
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .upload-area small {
        color: var(--text-gray);
        font-size: 14px;
      }

      #pdfInput {
        display: none;
      }

      .pdf-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .pdf-card {
        background: linear-gradient(135deg, var(--bg-light) 0%, #f3f4f6 100%);
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
        transition: all 0.3s;
      }

      .pdf-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
      }

      .pdf-name {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 8px;
        word-break: break-word;
        font-size: 14px;
      }

      .pdf-date {
        color: var(--text-gray);
        font-size: 12px;
        margin-bottom: 16px;
      }

      .pdf-actions {
        display: flex;
        gap: 10px;
      }

      .pdf-actions button {
        flex: 1;
        padding: 10px;
        font-size: 12px;
      }

      .segment-btn {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      }

      .delete-btn {
        background: var(--danger);
      }

      .roadmap-section {
        margin-top: 30px;
      }

      .roadmap-header {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 30px;
        border-left: 4px solid var(--primary);
      }

      .roadmap-title {
        color: var(--text-dark);
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .roadmap-overview {
        color: var(--text-gray);
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 16px;
      }

      .roadmap-meta {
        display: flex;
        gap: 24px;
        font-size: 13px;
        color: var(--text-gray);
        flex-wrap: wrap;
      }

      .segment-card {
        position: relative;
        padding-left: 40px;
        padding-bottom: 24px;
      }

      .segment-card::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 30px;
        bottom: -24px;
        width: 2px;
        background: var(--border);
      }

      .segment-card:last-child::before {
        display: none;
      }

      .segment-number {
        position: absolute;
        left: -5px;
        top: 0;
        width: 30px;
        height: 30px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .segment-content {
        background: var(--bg-light);
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
      }

      .segment-title {
        color: var(--text-dark);
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .segment-description {
        color: var(--text-gray);
        font-size: 14px;
        margin-bottom: 12px;
        line-height: 1.6;
      }

      .segment-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .difficulty-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        text-transform: capitalize;
      }

      .difficulty-beginner {
        background: var(--accent);
      }

      .difficulty-intermediate {
        background: var(--warning);
      }

      .difficulty-advanced {
        background: var(--danger);
      }

      .time-badge {
        color: var(--text-gray);
        font-size: 12px;
      }

      .key-points {
        margin-top: 12px;
      }

      .key-points-title {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 12px;
        margin-bottom: 8px;
      }

      .key-points ul {
        list-style: none;
        padding-left: 0;
      }

      .key-points li {
        color: var(--text-gray);
        font-size: 13px;
        padding: 4px 0;
        padding-left: 20px;
        position: relative;
      }

      .key-points li::before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: var(--accent);
        font-weight: 700;
      }

      .empty-state {
        text-align: center;
        color: var(--text-gray);
        padding: 60px 40px;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .empty-state p {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .back-btn {
        background: none;
        color: var(--primary);
        border: none;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 30px;
        padding: 0;
        font-weight: 600;
      }

      .back-btn:hover {
        color: var(--primary-dark);
      }

      .info-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 24px;
        border-left: 4px solid var(--primary);
        font-size: 14px;
        color: var(--text-dark);
      }

      @media (max-width: 768px) {
        .auth-box {
          padding: 32px 24px;
        }

        .profile-header {
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }

        .user-card {
          flex-direction: column;
        }

        .section {
          padding: 24px;
        }

        .pdf-list {
          grid-template-columns: 1fr;
        }

        .segment-meta {
          flex-direction: column;
        }

        .logo h1 {
          font-size: 28px;
        }
      }
    </style>
  </head>
  <body>
    <!-- LOGIN VIEW -->
    <div id="loginView" class="view active">
      <div class="auth-container">
        <div class="auth-box">
          <div class="logo">
            <h1>üìö DocVia</h1>
            <p>Smart Document Segmentation</p>
          </div>

          <div id="loginMessage"></div>

          <button class="google-btn" onclick="googleSignIn()">
            üîµ Continue with Google
          </button>

          <div class="divider"><span>or email</span></div>

          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" placeholder="you@example.com" required />
              <div class="error-message" id="loginEmailError"></div>
            </div>

            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              <div class="error-message" id="loginPasswordError"></div>
            </div>

            <button type="submit" id="loginBtn">Sign In</button>
          </form>

          <div class="text-center">
            <button class="link-btn" onclick="showView('registerView')">
              Don't have an account? Sign up
            </button>
            <button class="link-btn" onclick="showView('forgotView')">
              Forgot password?
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- REGISTER VIEW -->
    <div id="registerView" class="view">
      <div class="auth-container">
        <div class="auth-box">
          <button class="back-btn" onclick="showView('loginView')">‚Üê Back</button>

          <div class="logo">
            <h1>üìö DocVia</h1>
            <p>Create Your Account</p>
          </div>

          <div id="registerMessage"></div>

          <button class="google-btn" onclick="googleSignIn()">
            <svg width="18" height="18" viewBox="0 0 18 18">
              <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"></path>
              <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"></path>
              <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"></path>
              <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"></path>
            </svg>
            Sign up with Google
          </button>

          <div class="divider"><span>OR</span></div>

          <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="form-group">
              <label for="registerEmail">Email Address</label>
              <input type="email" id="registerEmail" placeholder="you@example.com" required />
              <div class="error-message" id="registerEmailError"></div>
            </div>

            <div class="form-group">
              <label for="registerPassword">Password</label>
              <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required />
              <div class="error-message" id="registerPasswordError"></div>
            </div>

            <button type="submit" id="registerBtn">Create Account</button>
          </form>

          <div class="text-center">
            <button class="link-btn" onclick="showView('loginView')">
              Already have an account? Sign in
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- FORGOT PASSWORD VIEW -->
    <div id="forgotView" class="view">
      <div class="auth-container">
        <div class="auth-box">
          <button class="back-btn" onclick="showView('loginView')">‚Üê Back</button>

          <div class="logo">
            <h1>üìö DocVia</h1>
            <p>Reset Your Password</p>
          </div>

          <div id="forgotMessage"></div>

          <div class="info-box">
            Enter your email and we'll send you a link to reset your password.
          </div>

          <form id="forgotForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
              <label for="forgotEmail">Email Address</label>
              <input type="email" id="forgotEmail" placeholder="you@example.com" required />
              <div class="error-message" id="forgotEmailError"></div>
            </div>

            <button type="submit" id="forgotBtn">Send Reset Link</button>
          </form>
        </div>
      </div>
    </div>

    <!-- RESET PASSWORD VIEW -->
    <div id="resetView" class="view">
      <div class="auth-container">
        <div class="auth-box">
          <button class="back-btn" onclick="showView('loginView')">‚Üê Back</button>

          <div class="logo">
            <h1>üìö DocVia</h1>
            <p>Reset Your Password</p>
          </div>

          <div id="resetMessage"></div>

          <form id="resetForm" onsubmit="handleResetPassword(event)">
            <div class="form-group">
              <label for="resetPassword">New Password</label>
              <input type="password" id="resetPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required />
              <div class="error-message" id="resetPasswordError"></div>
            </div>

            <div class="form-group">
              <label for="resetPasswordConfirm">Confirm Password</label>
              <input type="password" id="resetPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required />
              <div class="error-message" id="resetPasswordConfirmError"></div>
            </div>

            <button type="submit" id="resetBtn">Reset Password</button>
          </form>
        </div>
      </div>
    </div>

    <!-- PROFILE/DASHBOARD VIEW -->
    <div id="profileView" class="view">
      <div class="profile-container">
        <div class="profile-header">
          <div class="user-card">
            <img id="userAvatar" src="" alt="Avatar" class="user-avatar" />
            <div class="user-info">
              <h2 id="userName">Welcome</h2>
              <p id="userEmail">Loading...</p>
            </div>
          </div>
          <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>

        <div id="profileMessage"></div>

        <!-- PDF SECTION -->
        <div class="section">
          <h3>üì§ Upload Academic PDF</h3>
          <div id="pdfMessage"></div>

          <form id="pdfForm" onsubmit="handlePDFUpload(event)">
            <div class="form-group">
              <label for="pdfFile">Select PDF Document</label>
              <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
                <p>üìÅ Click to upload or drag & drop</p>
                <small>PDF files only (max 50MB)</small>
              </div>
              <input type="file" id="pdfFile" accept=".pdf" required />
              <div id="fileInfo" style="display: none; background: var(--bg-light); border-left: 4px solid var(--primary); padding: 12px; margin-top: 12px; border-radius: 10px; font-size: 13px; color: var(--text-dark);"></div>
            </div>

            <button type="submit" id="pdfUploadBtn" style="margin-top: 20px;">
              <span id="pdfUploadBtnText">üì§ Upload PDF</span>
            </button>
          </form>

          <div id="pdfResponse" style="display: none; background: var(--bg-light); padding: 16px; border-radius: 10px; margin-top: 24px;">
            <h4 style="color: var(--text-dark); margin-bottom: 12px; font-size: 14px; font-weight: 600;">Upload Response:</h4>
            <pre id="pdfResponseJson" style="background: var(--bg-white); padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 11px; color: var(--text-gray); line-height: 1.4; max-height: 300px; overflow-y: auto;"></pre>
          </div>

          <div style="margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">üìã Your PDFs</h3>
              <button type="button" onclick="loadPDFList()" class="link-btn" style="margin: 0; width: auto;">üîÑ Refresh</button>
            </div>
            <div id="pdfList" class="pdf-list"></div>
          </div>
        </div>

        <!-- ROADMAP SECTION -->
        <div class="section roadmap-section">
          <h3>üó∫Ô∏è Learning Roadmap</h3>
          <div id="roadmapDisplay" style="display: none;"></div>
          <div id="roadmapEmpty" class="empty-state">
            <div class="empty-state-icon">üöÄ</div>
            <p>Select a document and click "Segment"</p>
            <p style="font-size: 13px;">to generate a learning roadmap</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3001/api/auth";
      const PDF_API_URL = "http://localhost:3001/api/pdf";
      let authToken = localStorage.getItem("authToken");
      let currentUser = null;
      let currentSegmentation = null;

      window.addEventListener('DOMContentLoaded', () => {
        handleOAuthCallback();
        checkAuthState();
      });

      function showView(viewName) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewName).classList.add('active');
      }

      function showMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        if (element) {
          element.className = `message ${type}`;
          element.textContent = message;
        }
      }

      function clearMessages() {
        document.querySelectorAll('.message').forEach(m => m.textContent = '');
        document.querySelectorAll('.error-message').forEach(e => e.classList.remove('show'));
      }

      function checkAuthState() {
        if (authToken) {
          loadProfile();
          showView('profileView');
        } else {
          showView('loginView');
        }
      }

      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const response = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage("loginMessage", "‚úì Logged in successfully!", "success");
            setTimeout(() => {
              loadProfile();
              showView("profileView");
            }, 500);
          } else {
            showMessage("loginMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("loginMessage", "Network error. Please try again.", "error");
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        try {
          const response = await fetch(`${API_URL}/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage("registerMessage", "‚úì Account created successfully!", "success");
            setTimeout(() => {
              loadProfile();
              showView("profileView");
            }, 500);
          } else {
            showMessage("registerMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("registerMessage", "Network error. Please try again.", "error");
        }
      }

      async function handleForgotPassword(e) {
        e.preventDefault();
        const email = document.getElementById("forgotEmail").value;

        try {
          const response = await fetch(`${API_URL}/forgot-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage("forgotMessage", "‚úì Reset link sent to your email", "success");
            setTimeout(() => showView('loginView'), 2000);
          } else {
            showMessage("forgotMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("forgotMessage", "Network error. Please try again.", "error");
        }
      }

      async function handleResetPassword(e) {
        e.preventDefault();
        const password = document.getElementById("resetPassword").value;
        const passwordConfirm = document.getElementById("resetPasswordConfirm").value;

        if (password !== passwordConfirm) {
          showMessage("resetMessage", "Passwords do not match", "error");
          return;
        }

        const resetToken = new URLSearchParams(window.location.hash.substring(1)).get("token");

        try {
          const response = await fetch(`${API_URL}/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: resetToken, password }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage("resetMessage", "‚úì Password reset successfully!", "success");
            setTimeout(() => showView('loginView'), 2000);
          } else {
            showMessage("resetMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("resetMessage", "Network error. Please try again.", "error");
        }
      }

      async function googleSignIn() {
        try {
          const response = await fetch(`${API_URL}/google`);
          const data = await response.json();

          if (data.success && data.data.url) {
            window.location.href = data.data.url;
          } else {
            showMessage("loginMessage", "Failed to initiate Google sign-in", "error");
          }
        } catch (error) {
          showMessage("loginMessage", "Network error. Please try again.", "error");
        }
      }

      // Handle OAuth callback
      function handleOAuthCallback() {
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const access_token = hashParams.get('access_token');
        
        const params = new URLSearchParams(window.location.search);
        const error = params.get('error');

        if (access_token) {
          verifyGoogleToken(access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
        } else if (error) {
          let errorMsg = 'Google sign-in failed';
          if (error === 'no_code') errorMsg = 'No authorization code received';
          if (error === 'auth_failed') errorMsg = 'Google authentication failed';
          if (error === 'server_error') errorMsg = 'Server error occurred';
          showMessage('loginMessage', errorMsg, 'error');
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }

      async function verifyGoogleToken(access_token) {
        try {
          showMessage('loginMessage', 'Verifying your Google account...', 'info');
          
          const response = await fetch(`${API_URL}/google/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token })
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage('loginMessage', `Welcome, ${data.data.user.name}!`, 'success');
            
            setTimeout(() => {
              showView('profileView');
              loadProfile();
            }, 1000);
          } else {
            showMessage('loginMessage', data.error || 'Google sign-in verification failed', 'error');
          }
        } catch (error) {
          console.error('Google verification error:', error);
          showMessage('loginMessage', 'Failed to verify Google sign-in. Please try again.', 'error');
        }
      }

      async function loadProfile() {
        try {
          const response = await fetch(`${API_URL}/profile`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();

          if (data.success) {
            currentUser = data.data.user;
            const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.email)}&background=667eea&color=fff&size=200`;
            document.getElementById("userAvatar").src = avatar;
            document.getElementById("userName").textContent = currentUser.email.split('@')[0];
            document.getElementById("userEmail").textContent = currentUser.email;
            loadPDFList();
          }
        } catch (error) {
          console.error('Profile error:', error);
        }
      }

      async function handleLogout() {
        localStorage.removeItem("authToken");
        authToken = null;
        currentUser = null;
        showView("loginView");
        showMessage("loginMessage", "‚úì You've been signed out", "success");
      }

      document.getElementById('pdfFile').addEventListener('change', function(e) {
        const file = this.files[0];
        const infoDiv = document.getElementById('fileInfo');
        
        if (file) {
          const sizeMB = (file.size / 1024 / 1024).toFixed(2);
          infoDiv.innerHTML = `‚úì <strong>${file.name}</strong> (${sizeMB} MB)`;
          infoDiv.style.display = 'block';
        } else {
          infoDiv.style.display = 'none';
        }
      });

      async function handlePDFUpload(e) {
        e.preventDefault();
        const file = document.getElementById('pdfFile').files[0];

        if (!file) {
          showMessage('pdfMessage', 'Please select a file', 'error');
          return;
        }

        const formData = new FormData();
        formData.append('pdf', file);
        const uploadBtn = document.getElementById('pdfUploadBtn');
        uploadBtn.disabled = true;

        try {
          showMessage('pdfMessage', '‚è≥ Uploading...', 'info');
          const response = await fetch(`${PDF_API_URL}/upload`, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            showMessage('pdfMessage', `‚úì ${data.data.originalFilename} uploaded!`, 'success');
            document.getElementById('pdfForm').reset();
            document.getElementById('fileInfo').style.display = 'none';
            setTimeout(() => loadPDFList(), 500);
          } else {
            showMessage('pdfMessage', `Upload failed: ${data.error}`, 'error');
          }
        } catch (error) {
          showMessage('pdfMessage', `Upload error: ${error.message}`, 'error');
        } finally {
          uploadBtn.disabled = false;
        }
      }

      async function loadPDFList() {
        try {
          const response = await fetch(`${PDF_API_URL}/list`);
          const data = await response.json();
          const pdfList = document.getElementById('pdfList');

          if (data.success && data.data.length > 0) {
            pdfList.innerHTML = data.data.map(file => `
              <div class="pdf-card">
                <div class="pdf-name">üìÑ ${file.name}</div>
                <div class="pdf-date">${new Date(file.created_at).toLocaleDateString()}</div>
                <div class="pdf-actions">
                  <button class="segment-btn" onclick="segmentDocument('${file.name}')">‚ú® Segment</button>
                  <button class="delete-btn" onclick="deletePDF('${file.name}')">üóëÔ∏è Delete</button>
                </div>
              </div>
            `).join('');
          } else {
            pdfList.innerHTML = '<div class="empty-state" style="padding: 40px 20px; grid-column: 1/-1;"><div class="empty-state-icon">üì≠</div><p>No PDFs yet</p></div>';
          }
        } catch (error) {
          console.error('List error:', error);
        }
      }

      async function deletePDF(filename) {
        if (!confirm(`Delete "${filename}"?`)) return;

        try {
          const response = await fetch(`${PDF_API_URL}/${filename}`, {
            method: 'DELETE'
          });

          const data = await response.json();

          if (data.success) {
            showMessage('pdfMessage', `‚úì PDF deleted`, 'success');
            loadPDFList();
          } else {
            showMessage('pdfMessage', `Delete failed: ${data.error}`, 'error');
          }
        } catch (error) {
          showMessage('pdfMessage', `Delete error: ${error.message}`, 'error');
        }
      }

      async function segmentDocument(pdfId) {
        const authToken = localStorage.getItem('authToken');
        if (!authToken || !currentUser) {
          showMessage('pdfMessage', 'Please log in first', 'error');
          return;
        }

        try {
          showMessage('pdfMessage', 'ü§ñ AI is analyzing your document...', 'info');

          const response = await fetch(`http://localhost:3001/api/pdf/segment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              pdfId: pdfId,
              userId: currentUser.id
            })
          });

          const data = await response.json();

          if (data.success) {
            currentSegmentation = data.data;
            displayRoadmap();
            showMessage('pdfMessage', '‚úÖ Document segmented successfully!', 'success');
          } else {
            showMessage('pdfMessage', `Segmentation failed: ${data.error}`, 'error');
          }
        } catch (error) {
          showMessage('pdfMessage', `Segmentation error: ${error.message}`, 'error');
          console.error('Segmentation error:', error);
        }
      }

      function displayRoadmap() {
        if (!currentSegmentation) return;

        const roadmapDiv = document.getElementById('roadmapDisplay');
        if (!roadmapDiv) return;

        const data = currentSegmentation;

        let html = `
          <div class="roadmap-header">
            <h2 class="roadmap-title">üìö ${data.title}</h2>
            <p class="roadmap-overview">${data.overview}</p>
            <div class="roadmap-meta">
              <span>üìñ ${data.totalSegments} segments</span>
              <span>‚è±Ô∏è ${data.estimatedTime}</span>
              <span>üí∞ ${data.cost}</span>
            </div>
          </div>
          <div>
        `;

        data.segments.forEach((segment) => {
          const diffColor = segment.difficulty === 'beginner' ? '#10b981' : 
                           segment.difficulty === 'intermediate' ? '#f59e0b' : '#ef4444';
          
          html += `
            <div class="segment-card">
              <div class="segment-number">${segment.id}</div>
              <div class="segment-content">
                <div class="segment-title">${segment.title}</div>
                <p class="segment-description">${segment.description}</p>
                <div class="segment-meta">
                  <span class="difficulty-badge difficulty-${segment.difficulty}">${segment.difficulty}</span>
                  <span class="time-badge">‚è±Ô∏è ${segment.estimatedTime}</span>
                </div>
                <div class="key-points">
                  <div class="key-points-title">Key Points:</div>
                  <ul>
                    ${segment.keyPoints.map(point => `<li>${point}</li>`).join('')}
                  </ul>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
        roadmapDiv.innerHTML = html;
        roadmapDiv.style.display = 'block';
        document.getElementById('roadmapEmpty').style.display = 'none';
      }
    </script>
  </body>
</html>