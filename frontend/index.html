<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocVia - Sign In</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        padding: 40px;
        max-width: 440px;
        width: 100%;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        color: #667eea;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .logo p {
        color: #666;
        font-size: 14px;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s;
        font-family: inherit;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      input.error {
        border-color: #ef4444;
      }

      .error-message {
        color: #ef4444;
        font-size: 13px;
        margin-top: 6px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-family: inherit;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .google-btn {
        background: white;
        color: #333;
        border: 2px solid #e0e0e0;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        font-weight: 500;
      }

      .google-btn:hover:not(:disabled) {
        background: #f8f9fa;
        border-color: #d0d0d0;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .divider {
        text-align: center;
        margin: 24px 0;
        position: relative;
      }

      .divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e0e0e0;
      }

      .divider span {
        background: white;
        padding: 0 12px;
        position: relative;
        color: #999;
        font-size: 13px;
        font-weight: 500;
      }

      .message {
        padding: 14px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }

      .message.info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
      }

      .link-btn {
        background: none;
        color: #667eea;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
        margin-top: 12px;
        padding: 8px 0;
        font-weight: 500;
        border: none;
        transition: color 0.2s;
      }

      .link-btn:hover {
        color: #764ba2;
        transform: none;
        box-shadow: none;
        text-decoration: underline;
      }

      .text-center {
        text-align: center;
      }

      .user-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 16px;
        display: block;
        border: 4px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .user-name {
        font-size: 22px;
        font-weight: 700;
        color: #333;
        margin-bottom: 4px;
        text-align: center;
      }

      .user-email {
        font-size: 14px;
        color: #666;
        text-align: center;
        margin-bottom: 16px;
      }

      .user-info-grid {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .user-info-item {
        background: white;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
      }

      .user-info-label {
        color: #666;
        font-weight: 500;
      }

      .user-info-value {
        color: #333;
        font-weight: 600;
      }

      .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        margin-top: 20px;
      }

      .logout-btn:hover:not(:disabled) {
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
      }

      .back-btn {
        background: #f3f4f6;
        color: #374151;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .back-btn:hover:not(:disabled) {
        background: #e5e7eb;
        box-shadow: none;
      }

      .info-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #1e40af;
        line-height: 1.6;
      }

      .info-box strong {
        display: block;
        margin-bottom: 8px;
        font-size: 15px;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .password-toggle {
        position: relative;
      }

      .password-toggle input {
        padding-right: 48px;
      }

      .password-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 8px;
        width: auto;
        font-size: 14px;
      }

      .password-toggle-btn:hover {
        color: #333;
        transform: translateY(-50%);
        box-shadow: none;
      }

      .strength-meter {
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        margin-top: 8px;
        overflow: hidden;
      }

      .strength-meter-fill {
        height: 100%;
        width: 0%;
        transition: all 0.3s;
        border-radius: 2px;
      }

      .strength-weak { width: 33%; background: #ef4444; }
      .strength-medium { width: 66%; background: #f59e0b; }
      .strength-strong { width: 100%; background: #10b981; }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">
        <h1>üìÑ DocVia - Backend Testing</h1>
        <p>Academic PDF Reader</p>
      </div>

      <!-- Login View -->
      <div id="loginView" class="view active">
        <div id="loginMessage"></div>

        <button class="google-btn" onclick="googleSignIn()">
          <svg width="18" height="18" viewBox="0 0 18 18">
            <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"></path>
            <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"></path>
            <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"></path>
            <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"></path>
          </svg>
          Continue with Google
        </button>

        <div class="divider"><span>OR</span></div>

        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="loginEmail">Email address</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="you@example.com"
              required
            />
            <div class="error-message" id="loginEmailError"></div>
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <div class="password-toggle">
              <input
                type="password"
                id="loginPassword"
                placeholder="Enter your password"
                required
              />
              <button type="button" class="password-toggle-btn" onclick="togglePassword('loginPassword')">
                Show
              </button>
            </div>
            <div class="error-message" id="loginPasswordError"></div>
          </div>
          <button type="submit" id="loginBtn">
            Sign In
          </button>
        </form>

        <div class="text-center">
          <button class="link-btn" onclick="showView('forgotView')">
            Forgot your password?
          </button>
        </div>

        <div class="divider"><span></span></div>

        <div class="text-center">
          <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
            Don't have an account?
          </p>
          <button class="link-btn" onclick="showView('registerView')" style="font-weight: 600;">
            Create an account
          </button>
        </div>
      </div>

      <!-- Register View -->
      <div id="registerView" class="view">
        <button class="back-btn" onclick="showView('loginView')">
          ‚Üê Back to Sign In
        </button>

        <div id="registerMessage"></div>

        <button class="google-btn" onclick="googleSignIn()">
          <svg width="18" height="18" viewBox="0 0 18 18">
            <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"></path>
            <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"></path>
            <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"></path>
            <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"></path>
          </svg>
          Sign up with Google
        </button>

        <div class="divider"><span>OR</span></div>

        <form id="registerForm" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="registerEmail">Email address</label>
            <input
              type="email"
              id="registerEmail"
              placeholder="you@example.com"
              required
            />
            <div class="error-message" id="registerEmailError"></div>
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <div class="password-toggle">
              <input
                type="password"
                id="registerPassword"
                placeholder="Create a password (min 6 characters)"
                required
                oninput="checkPasswordStrength(this.value)"
              />
              <button type="button" class="password-toggle-btn" onclick="togglePassword('registerPassword')">
                Show
              </button>
            </div>
            <div class="strength-meter">
              <div class="strength-meter-fill" id="strengthMeter"></div>
            </div>
            <div class="error-message" id="registerPasswordError"></div>
          </div>
          <button type="submit" id="registerBtn">
            Create Account
          </button>
        </form>
      </div>

      <!-- Forgot Password View -->
      <div id="forgotView" class="view">
        <button class="back-btn" onclick="showView('loginView')">
          ‚Üê Back to Sign In
        </button>

        <div id="forgotMessage"></div>

        <div class="info-box">
          <strong>üîê Reset your password</strong>
          Enter your email address and we'll send you a link to reset your password.
        </div>

        <form id="forgotForm" onsubmit="handleForgotPassword(event)">
          <div class="form-group">
            <label for="forgotEmail">Email address</label>
            <input
              type="email"
              id="forgotEmail"
              placeholder="you@example.com"
              required
            />
            <div class="error-message" id="forgotEmailError"></div>
          </div>
          <button type="submit" id="forgotBtn">
            Send Reset Link
          </button>
        </form>
      </div>

      <!-- Reset Password View -->
      <div id="resetView" class="view">
        <button class="back-btn" onclick="showView('loginView')">
          ‚Üê Back to Sign In
        </button>

        <div class="logo">
          <h1>DocVia</h1>
          <p>Reset Your Password</p>
        </div>

        <div id="resetMessage"></div>

        <form id="resetForm" onsubmit="handleResetPassword(event)">
          <div class="form-group">
            <label for="resetPassword">New Password</label>
            <input
              type="password"
              id="resetPassword"
              placeholder="Enter new password"
              minlength="6"
              required
            />
            <button type="button" class="password-toggle-btn" onclick="togglePassword('resetPassword')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
            <div class="error-message" id="resetPasswordError"></div>
          </div>

          <div class="form-group">
            <label for="resetPasswordConfirm">Confirm Password</label>
            <input
              type="password"
              id="resetPasswordConfirm"
              placeholder="Confirm new password"
              minlength="6"
              required
            />
            <button type="button" class="password-toggle-btn" onclick="togglePassword('resetPasswordConfirm')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
            <div class="error-message" id="resetPasswordConfirmError"></div>
          </div>

          <button type="submit" id="resetBtn">
            Reset Password
          </button>
        </form>
      </div>

      <!-- Profile View -->
      <div id="profileView" class="view">
        <div id="profileMessage"></div>
        <div id="profileData"></div>
        
        <!-- PDF Upload Section (shown in profile) -->
        <div id="pdfSection" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e5e7eb;">
          <h3 style="color: #333; margin-bottom: 20px; font-size: 18px; font-weight: 600;">üìÑ Upload Academic PDF</h3>
          
          <div id="pdfMessage"></div>
          
          <form id="pdfForm" onsubmit="handlePDFUpload(event)" style="margin-bottom: 30px;">
            <div class="form-group">
              <label for="pdfFile">Select PDF Document:</label>
              <input type="file" id="pdfFile" accept=".pdf" required style="padding: 10px;">
              <div id="fileInfo" style="display: none; background: #f0f9ff; border-left: 4px solid #667eea; padding: 12px; margin-top: 12px; border-radius: 6px; font-size: 13px; color: #333;"></div>
            </div>
            
            <button type="submit" id="pdfUploadBtn" style="margin-top: 15px;">
              <span id="pdfUploadBtnText">üì§ Upload PDF</span>
            </button>
          </form>
          
          <div id="pdfResponse" style="display: none; background: #f3f4f6; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <h4 style="color: #333; margin-bottom: 12px; font-size: 14px;">Upload Response:</h4>
            <pre id="pdfResponseJson" style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 11px; color: #333; line-height: 1.4;"></pre>
          </div>
          
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px; font-size: 16px; font-weight: 600;">üìã Uploaded PDFs</h3>
            <button type="button" onclick="loadPDFList()" class="link-btn" style="background: #f3f4f6; color: #333; width: 100%; margin-top: 0;">
              üîÑ Refresh PDF List
            </button>
            <div id="pdfList" style="margin-top: 15px;"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3001/api/auth";
      const PDF_API_URL = "http://localhost:3001/api/pdf";
      let authToken = localStorage.getItem("authToken");
      let currentUser = null;

      // Initialize app
      window.addEventListener('DOMContentLoaded', () => {
        checkForResetToken();  // Check this FIRST
        handleOAuthCallback();
        checkAuthState();      // Then check auth state
      });

      // Check if user is already logged in
      function checkAuthState() {
        // Check for reset token in BOTH query params and hash
        const searchParams = new URLSearchParams(window.location.search);
        let resetToken = searchParams.get("token");
        
        if (!resetToken) {
          const hash = window.location.hash.substring(1);
          const hashParams = new URLSearchParams(hash);
          resetToken = hashParams.get("token");
        }
        
        if (resetToken) {
          // Skip auto-login when resetting password
          console.log("üîê Reset token detected - skipping auto-login");
          return;
        }
        
        if (authToken) {
          showView('profileView');
          loadProfile();
        }
      }

      // Handle OAuth callback
      function handleOAuthCallback() {
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const access_token = hashParams.get('access_token');
        
        const params = new URLSearchParams(window.location.search);
        const error = params.get('error');

        if (access_token) {
          verifyGoogleToken(access_token);
          window.history.replaceState({}, document.title, window.location.pathname);
        } else if (error) {
          let errorMsg = 'Google sign-in failed';
          if (error === 'no_code') errorMsg = 'No authorization code received';
          if (error === 'auth_failed') errorMsg = 'Google authentication failed';
          if (error === 'server_error') errorMsg = 'Server error occurred';
          showMessage('loginMessage', errorMsg, 'error');
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }

      async function verifyGoogleToken(access_token) {
        try {
          showMessage('loginMessage', 'Verifying your Google account...', 'info');
          
          const response = await fetch(`${API_URL}/google/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token })
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage('loginMessage', `Welcome, ${data.data.user.name}!`, 'success');
            
            setTimeout(() => {
              showView('profileView');
              loadProfile();
            }, 1000);
          } else {
            showMessage('loginMessage', data.error || 'Google sign-in verification failed', 'error');
          }
        } catch (error) {
          console.error('Google verification error:', error);
          showMessage('loginMessage', 'Failed to verify Google sign-in. Please try again.', 'error');
        }
      }

      function showView(viewName) {
        // Hide all views
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });

        // Clear all messages
        clearMessages();

        // Show requested view
        document.getElementById(viewName).classList.add('active');

        // Load profile data if showing profile
        if (viewName === 'profileView') {
          if (!authToken) {
            showView('loginView');
            showMessage('loginMessage', 'Please sign in to view your profile', 'info');
            return;
          }
          loadProfile();
        }

        // Prevent accessing login/register when already logged in
        if ((viewName === 'loginView' || viewName === 'registerView') && authToken) {
          showView('profileView');
          return;
        }
      }

      function showMessage(elementId, message, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
      }

      function clearMessages() {
        document.querySelectorAll('[id$="Message"]').forEach(el => el.innerHTML = '');
        document.querySelectorAll('.error-message').forEach(el => {
          el.classList.remove('show');
          el.textContent = '';
        });
        document.querySelectorAll('input').forEach(input => input.classList.remove('error'));
      }

      function showFieldError(fieldId, message) {
        const input = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + 'Error');
        if (input && errorDiv) {
          input.classList.add('error');
          errorDiv.textContent = message;
          errorDiv.classList.add('show');
        }
      }

      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const btn = input.nextElementSibling;
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Hide';
        } else {
          input.type = 'password';
          btn.textContent = 'Show';
        }
      }

      function checkPasswordStrength(password) {
        const meter = document.getElementById('strengthMeter');
        let strength = 0;
        
        if (password.length >= 6) strength++;
        if (password.length >= 10) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        meter.className = 'strength-meter-fill';
        if (strength <= 2) {
          meter.classList.add('strength-weak');
        } else if (strength <= 3) {
          meter.classList.add('strength-medium');
        } else {
          meter.classList.add('strength-strong');
        }
      }

      async function handleLogin(event) {
        event.preventDefault();
        clearMessages();
        
        const btn = document.getElementById("loginBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Signing in...';

        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value;

        try {
          const response = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage("loginMessage", "Welcome back!", "success");
            document.getElementById("loginForm").reset();

            setTimeout(() => {
              showView("profileView");
            }, 1000);
          } else {
            showMessage("loginMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("loginMessage", "Network error. Please check your connection.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      async function handleRegister(event) {
        event.preventDefault();
        clearMessages();
        
        const btn = document.getElementById("registerBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Creating account...';

        const email = document.getElementById("registerEmail").value.trim();
        const password = document.getElementById("registerPassword").value;

        // Validate password
        if (password.length < 6) {
          showFieldError('registerPassword', 'Password must be at least 6 characters');
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        try {
          const response = await fetch(`${API_URL}/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (data.success) {
            authToken = data.data.token;
            currentUser = data.data.user;
            localStorage.setItem("authToken", authToken);
            showMessage("registerMessage", "Account created successfully!", "success");
            document.getElementById("registerForm").reset();

            setTimeout(() => {
              showView("profileView");
            }, 1000);
          } else {
            showMessage("registerMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("registerMessage", "Network error. Please check your connection.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      async function handleForgotPassword(event) {
        event.preventDefault();
        clearMessages();
        
        const btn = document.getElementById("forgotBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Sending email...';

        const email = document.getElementById("forgotEmail").value.trim();

        try {
          const response = await fetch(`${API_URL}/forgot-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage("forgotMessage", 
              "‚úÖ Password reset email sent! Check your inbox (and spam folder) for a link to reset your password.", 
              "success"
            );
            document.getElementById("forgotForm").reset();
            
            // Show additional info
            setTimeout(() => {
              const currentMsg = document.getElementById("forgotMessage").innerHTML;
              document.getElementById("forgotMessage").innerHTML = currentMsg + 
                '<div class="info-box" style="margin-top: 16px;"><strong>üìß What\'s next?</strong>Click the link in the email to reset your password. The link will expire in 1 hour for security.</div>';
            }, 500);
          } else {
            showMessage("forgotMessage", data.error, "error");
          }
        } catch (error) {
          showMessage("forgotMessage", "Network error. Please check your connection.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      /**
       * Handle Reset Password Form Submission
       */
      async function handleResetPassword(event) {
        event.preventDefault();
        clearMessages();

        const password = document.getElementById("resetPassword").value.trim();
        const confirmPassword = document.getElementById("resetPasswordConfirm").value.trim();

        // Validation
        if (!password || !confirmPassword) {
          showMessage("resetMessage", "Please enter and confirm your new password.", "error");
          return;
        }

        if (password.length < 6) {
          showMessage("resetMessage", "Password must be at least 6 characters long.", "error");
          return;
        }

        if (password !== confirmPassword) {
          showMessage("resetMessage", "Passwords do not match.", "error");
          return;
        }

        const btn = document.getElementById("resetBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Resetting password...';

        try {
          // Get token from URL or sessionStorage
          let token = null;
          
          // Try getting from URL first
          const searchParams = new URLSearchParams(window.location.search);
          token = searchParams.get("token");
          
          // If not in URL, check hash
          if (!token && window.location.hash) {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            token = hashParams.get("token");
            
            // Also check for access_token format
            if (!token) {
              token = hashParams.get("access_token");
            }
          }
          
          // If still not found, try sessionStorage
          if (!token) {
            token = sessionStorage.getItem("resetToken");
          }

          if (!token) {
            console.error("‚ùå No token found");
            showMessage("resetMessage", "Invalid or expired reset link. Please request a new password reset.", "error");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          console.log("üîÑ Sending reset password request...");
          console.log("Token length:", token.length);

          const response = await fetch(`${API_URL}/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token,
              newPassword: password
            }),
          });

          const data = await response.json();

          if (data.success) {
            console.log("‚úÖ Password reset successful");
            showMessage("resetMessage", 
              "‚úÖ " + data.message + " You'll be redirected to login in 3 seconds...", 
              "success"
            );
            
            // Clear the stored token
            sessionStorage.removeItem("resetToken");
            
            // Clear the form
            document.getElementById("resetForm").reset();

            // Redirect to login after 3 seconds
            setTimeout(() => {
              window.history.replaceState({}, document.title, window.location.pathname);
              showView('loginView');
            }, 3000);
          } else {
            console.error("‚ùå Password reset failed:", data.error);
            showMessage("resetMessage", data.error || "Failed to reset password.", "error");
          }
        } catch (error) {
          console.error("Reset password error:", error);
          showMessage("resetMessage", "Network error. Please check your connection.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      /**
       * Check if user clicked password reset link from email
       * This should run on page load
       */
      function checkForResetToken() {
        console.log("üîç Checking for reset token...");
        console.log("Current URL:", window.location.href);
        console.log("Search:", window.location.search);
        console.log("Hash:", window.location.hash);
        
        let token = null;
        let type = null;

        // Method 1: Check query parameters (?token=...)
        const searchParams = new URLSearchParams(window.location.search);
        token = searchParams.get("token");
        type = searchParams.get("type");

        console.log("From search params - Token:", token, "Type:", type);

        // Method 2: If not found, check hash (#token=...)
        if (!token && window.location.hash) {
          const hash = window.location.hash.substring(1);
          const hashParams = new URLSearchParams(hash);
          token = hashParams.get("token");
          type = hashParams.get("type");
          console.log("From hash - Token:", token, "Type:", type);
        }

        // Method 3: Check if access_token in hash (Supabase OAuth format)
        if (!token && window.location.hash) {
          const hash = window.location.hash.substring(1);
          const hashParams = new URLSearchParams(hash);
          const accessToken = hashParams.get("access_token");
          const hashType = hashParams.get("type");
          
          if (accessToken && hashType === "recovery") {
            token = accessToken;
            type = "recovery";
            console.log("From access_token - Token:", token, "Type:", type);
          }
        }

        console.log("Final extracted - Token:", token ? "‚úÖ Found" : "‚ùå Not found", "Type:", type);

        // If we have a valid reset token, show the reset password view
        if (token && (type === "recovery" || type === "magiclink")) {
          console.log("‚úÖ Valid reset token found! Showing reset password form.");
          
          // IMPORTANT: Clear the auth token so profile doesn't auto-load
          localStorage.removeItem("authToken");
          authToken = null;
          currentUser = null;
          
          // Store token for later use
          sessionStorage.setItem("resetToken", token);
          
          // Clean up URL - remove hash/query params
          window.history.replaceState({}, document.title, '/reset-password');
          showView('resetView');
        } else if (token || type) {
          // Token exists but invalid format
          console.warn("‚ö†Ô∏è  Invalid token format - Token:", token, "Type:", type);
          showView('loginView');
          showMessage("loginMessage", "Invalid or expired reset link. Please request a new password reset.", "error");
        } else {
          console.log("‚ÑπÔ∏è  No reset token found in URL");
        }
      }

      async function googleSignIn() {
        try {
          const response = await fetch(`${API_URL}/google`);
          const data = await response.json();

          if (data.success && data.data.url) {
            window.location.href = data.data.url;
          } else {
            showMessage("loginMessage", "Failed to initiate Google sign-in", "error");
          }
        } catch (error) {
          showMessage("loginMessage", "Network error. Please try again.", "error");
        }
      }

      async function loadProfile() {
        const profileData = document.getElementById("profileData");
        const profileMessage = document.getElementById("profileMessage");

        if (!authToken) {
          showView('loginView');
          showMessage('loginMessage', 'Please sign in to view your profile', 'info');
          return;
        }

        try {
          const response = await fetch(`${API_URL}/profile`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });

          const data = await response.json();

          if (data.success) {
            const user = data.data.user;
            const avatar = currentUser?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=667eea&color=fff&size=200`;
            const displayName = currentUser?.name || user.email.split('@')[0];
            
            profileData.innerHTML = `
              <div class="user-card">
                <img src="${avatar}" alt="Avatar" class="user-avatar" />
                <div class="user-name">${displayName}</div>
                <div class="user-email">${user.email}</div>
                
                <div class="user-info-grid">
                  <div class="user-info-item">
                    <span class="user-info-label">User ID</span>
                    <span class="user-info-value">${user.id.substring(0, 8)}...</span>
                  </div>
                  <div class="user-info-item">
                    <span class="user-info-label">Account Created</span>
                    <span class="user-info-value">${new Date(user.created_at).toLocaleDateString()}</span>
                  </div>
                  <div class="user-info-item">
                    <span class="user-info-label">Last Sign In</span>
                    <span class="user-info-value">${new Date(user.last_sign_in).toLocaleDateString()}</span>
                  </div>
                </div>
              </div>
              <button class="logout-btn" onclick="handleLogout()">
                Sign Out
              </button>
            `;
            profileMessage.innerHTML = "";
          } else {
            profileData.innerHTML = "";
            showMessage("profileMessage", data.error, "error");
            if (response.status === 401 || response.status === 403) {
              localStorage.removeItem("authToken");
              authToken = null;
              currentUser = null;
              setTimeout(() => showView('loginView'), 2000);
            }
          }
        } catch (error) {
          profileData.innerHTML = "";
          showMessage("profileMessage", "Network error. Please try again.", "error");
        }
      }

      async function handleLogout() {
        try {
          await fetch(`${API_URL}/logout`, {
            method: "POST",
            headers: { Authorization: `Bearer ${authToken}` },
          });

          localStorage.removeItem("authToken");
          authToken = null;
          currentUser = null;
          document.getElementById("profileData").innerHTML = "";
          
          showView('loginView');
          showMessage("loginMessage", "You've been signed out successfully", "success");
        } catch (error) {
          console.error('Logout error:', error);
          // Still log out locally even if server request fails
          localStorage.removeItem("authToken");
          authToken = null;
          currentUser = null;
          showView('loginView');
        }
      }

      // ===== PDF UPLOAD FUNCTIONS =====

      document.getElementById('pdfFile').addEventListener('change', function(e) {
        const file = this.files[0];
        const infoDiv = document.getElementById('fileInfo');
        
        if (file) {
          const sizeMB = (file.size / 1024 / 1024).toFixed(2);
          const sizeKB = (file.size / 1024).toFixed(2);
          infoDiv.innerHTML = `
            <strong>File Selected:</strong> ${file.name}<br>
            <strong>Size:</strong> ${sizeMB} MB (${sizeKB} KB)<br>
            <strong>Type:</strong> ${file.type || 'application/pdf'}
          `;
          infoDiv.style.display = 'block';
        } else {
          infoDiv.style.display = 'none';
        }
      });

      async function handlePDFUpload(e) {
        e.preventDefault();

        const file = document.getElementById('pdfFile').files[0];
        if (!file) {
          showMessage('pdfMessage', 'Please select a file', 'error');
          return;
        }

        const formData = new FormData();
        formData.append('pdf', file);

        const uploadBtn = document.getElementById('pdfUploadBtn');
        const uploadBtnText = document.getElementById('pdfUploadBtnText');
        uploadBtn.disabled = true;
        uploadBtnText.textContent = '‚è≥ Uploading & Validating...';

        try {
          const response = await fetch(`${PDF_API_URL}/upload`, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            showMessage('pdfMessage', 
              `‚úì PDF uploaded successfully! File: ${data.data.originalFilename}`, 
              'success');
            
            // Show response
            const responseDiv = document.getElementById('pdfResponse');
            const jsonDiv = document.getElementById('pdfResponseJson');
            jsonDiv.textContent = JSON.stringify(data, null, 2);
            responseDiv.style.display = 'block';

            // Clear form
            document.getElementById('pdfForm').reset();
            document.getElementById('fileInfo').style.display = 'none';

            // Refresh PDF list
            setTimeout(() => loadPDFList(), 1000);
          } else {
            // PDF validation failed
            let errorMsg = data.error || 'Upload failed';
            
            if (data.errors && data.errors.length > 0) {
              errorMsg += '\n\nValidation Errors:';
              data.errors.forEach(err => {
                errorMsg += '\n‚Ä¢ ' + err;
              });
            }
            
            showMessage('pdfMessage', errorMsg, 'error');

            // Show response with validation details
            const responseDiv = document.getElementById('pdfResponse');
            const jsonDiv = document.getElementById('pdfResponseJson');
            
            let html = 'File Validation Failed\n\n';
            html += 'Message: ' + data.message + '\n\n';
            
            if (data.errors && data.errors.length > 0) {
              html += 'Errors:\n';
              data.errors.forEach(err => {
                html += '‚Ä¢ ' + err + '\n';
              });
              html += '\n';
            }
            
            if (data.warnings && data.warnings.length > 0) {
              html += 'Warnings:\n';
              data.warnings.forEach(warn => {
                html += '‚Ä¢ ' + warn + '\n';
              });
            }
            
            html += '\n\nFull Response:\n' + JSON.stringify(data, null, 2);
            jsonDiv.textContent = html;
            responseDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('Upload error:', error);
          showMessage('pdfMessage', 'Network error: ' + error.message, 'error');
        } finally {
          uploadBtn.disabled = false;
          uploadBtnText.textContent = 'üì§ Upload PDF';
        }
      }

      async function loadPDFList() {
        const pdfList = document.getElementById('pdfList');
        pdfList.innerHTML = '<p style="text-align: center; color: #999;">Loading PDFs...</p>';

        try {
          const response = await fetch(`${PDF_API_URL}/list`);
          const data = await response.json();

          if (data.success && data.data.length > 0) {
            let html = '';
            data.data.forEach(file => {
              const sizeMB = (file.metadata?.size / 1024 / 1024 || 0).toFixed(2);
              const createdAt = new Date(file.created_at).toLocaleString();
              html += `
                <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea;">
                  <div>
                    <div style="font-weight: 600; color: #333;">üìÑ ${file.name}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">
                      Size: ${sizeMB} MB | Uploaded: ${createdAt}
                    </div>
                  </div>
                  <button type="button" onclick="deletePDF('${file.name}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                    üóëÔ∏è Delete
                  </button>
                </div>
              `;
            });
            pdfList.innerHTML = html;
            showMessage('pdfMessage', `Found ${data.count} PDF(s)`, 'info');
          } else {
            pdfList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No PDFs uploaded yet</p>';
            showMessage('pdfMessage', 'No PDFs found', 'info');
          }
        } catch (error) {
          console.error('List error:', error);
          pdfList.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 20px;">Error loading PDFs: ${error.message}</p>`;
          showMessage('pdfMessage', 'Network error: ' + error.message, 'error');
        }
      }

      async function deletePDF(filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
          return;
        }

        try {
          const response = await fetch(`${PDF_API_URL}/${filename}`, {
            method: 'DELETE'
          });

          const data = await response.json();

          if (data.success) {
            showMessage('pdfMessage', `‚úì PDF deleted successfully`, 'success');
            loadPDFList();
          } else {
            showMessage('pdfMessage', `‚úó Failed to delete PDF: ${data.error}`, 'error');
          }
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('pdfMessage', 'Network error: ' + error.message, 'error');
        }
      }

      // Load PDF list when profile is loaded
      const originalLoadProfile = loadProfile;
      loadProfile = function() {
        originalLoadProfile.apply(this, arguments);
        setTimeout(() => {
          loadPDFList();
        }, 500);
      };
    </script>
  </body>
</html>